<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Dot Menu Imports</title>
<link rel="icon" href="./favicon.ico">
<style>
    @import url("http://dave-legacy/42/style/fave.css");
</style>
</head>
<body>
<header>Dot Menu Imports</header>
<main>
    <table>
        <thead>
<th>Decal</th>
<th>Title</th>
<th>TiKey</th>
<th>URL</th>
        </thead>
        <tbody id="rowset"></tbody>
    </table>
</main>
<footer>(footer)</footer>

<script>

const ella = t => document.createElement( t );

const siteURL = {
    "dave-ryzen"  : "http://192.168.1.125/applets/app/dotmenu/" ,
    "dave-legacy" : "http://192.168.1.155/42/app/stereogram/dot/menu/" ,
    "dave-omega"  : "http://192.168.1.155/42/app/stereogram/dot/menu/"
};

const site = siteURL[ location.hostname ]
    || siteURL[ "dave-omega" ];

console.log( "Site URL", site );


const NONE = "ðŸ’¢";

const SCHEMA = [ 
    "decal", "title", "tikey", "url"
];


function diagnoseTable( dotmenu ) {
    dotmenu.unshift( SCHEMA );
    console.group( "Dot Menu" );
    console.table( dotmenu );
    console.groupEnd();
}

function makeTable( dotmenu ) {
    /*
    function record( entry ) {
        const url = entry.url || NONE;
        const decal = entry.decal || NONE;
        const title = entry.title || NONE;
        const tikey = entry.tikey || NONE;
        return [
            decal ,
            title ,
            tikey ,
            url
        ];
    }
    */
    // dotmenu = dotmenu.map( record );
    // diagnoseTable( dotmenu );
    function cell( value ) {
        const td = ella( 'td' );
        td.innerText = value;
        return td;
    }
    function row( entry ) {
        const url = entry.url || NONE;
        const decal = entry.decal || NONE;
        const title = entry.title || NONE;
        const tikey = entry.tikey || NONE;
        const values = [
            decal, title, tikey, url
        ];        
        const tr = ella( 'tr' );
        function add( td ) {
            tr.appendChild( td )
        }
        values.map( cell ).forEach( add );
        return tr;
    }
    const rows = dotmenu.map( row );
    rowset.innerHTML = "";
    rows.forEach( o => rowset.appendChild( o ) );
}


function parsePayload( json ) {
    const arr = o => Array.isArray( o );
    function oops() {
        throw new Error( "JSON structure is invalid" );
    }
    try {
        const payload = JSON.parse( json );
        if (! arr( payload.menuDots ) ) { oops(); }
        const dots = payload.menuDots;
        if (! arr( dots[ 0 ] ) ) { oops(); }
        makeTable( dots[ 0 ] );
    } catch ( e ) {
        console.error( e );
        console.log( "Payload", json );
    }
}


function composeAssetURL( filename ) {
    return ( site + filename );
}


function fetchTextFile( url, onsuccess ) {
    return fetch( url )
        .then( resp=>resp.text())
        .then( text=>onsuccess( text ) )
        .catch( e => console.error( e ) );
}


function fetchObjectFile( url, onsuccess ) {
    return fetch( url )
        .then( resp => resp.json())
        .then( json => onsuccess( json ) )
        .catch( e => console.error( e ) );
}


function fetchDotMenu( filename = "auto-menu.json" ) {
    const url = composeAssetURL( filename );
    console.log( "URL:", url );
    fetchTextFile( url, parsePayload );    
    // fetchObjectFile( url, makeTable );    
}


function main() {
    try { 
        fetchDotMenu( "auto-menu.json" );
    } catch ( e ) { 
        console.error( e );
    }
}

addEventListener( 'load', main );

</script>

</body>
</html>